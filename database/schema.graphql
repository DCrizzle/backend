type Consent @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsent {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsent {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsent {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsent {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsent {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	donor: Donor!
	specimen: Specimen!
	protocol: Protocol!
	form: ConsentForm!
	consentedDate: DateTime! @search
	retentionPeriod: Int! @search
	destructionDate: DateTime! @search
}

type Donor implements Location @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{$role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryDonor {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{$role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryDonor {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{$role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryDonor {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{$role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryDonor {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryDonor {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	age: Int! @search
	dob: DateTime!
	sex: Sex!
	race: Race!
	specimens: [Specimen!]!
	consents: [Consent!]! @hasInverse(field: donor)
}

enum Sex {
	MALE
	FEMALE
}

enum Race {
	AMERICAN_INDIAN_OR_ALASKA_NATIVE
	ASIAN
	BLACK_OR_AFRICAN_AMERICAN
	HISPANIC_OR_LATINO
	WHITE
}

interface Form {
	id: ID!
	owner: OwnerOrg!
	title: String! @search(by: [fulltext])
	body: String! @search(by: [fulltext])
}

type ConsentForm implements Form @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{ $role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsentForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{ $role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsentForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{ $role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsentForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{ $role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsentForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryConsentForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	consent: Consent! @hasInverse(field: form)
}

type ProtocolForm implements Form @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocolForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocolForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocolForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocolForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{ $role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{ $role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocolForm {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	protocolID: String! @search
}

interface Org {
	id: ID!
	name: String!
	users: [User!]!
	createdOn: DateTime!
	updatedOn: DateTime!
}

type LabOrg implements Org & Location {
	owner: OwnerOrg!
	specimens: [Specimen!]! @hasInverse(field: lab)
}

type OwnerOrg implements Org & Location {
	labs: [LabOrg!]! @hasInverse(field: owner)
	storages: [StorageOrg!]! @hasInverse(field: owner)
}

type StorageOrg implements Org & Location {
	owner: OwnerOrg!
	specimens: [Specimen!]! @hasInverse(field: storage)
}

type Plan @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryPlan {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryPlan {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryPlan {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryPlan {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryPlan {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	name: String!
	labs: [LabOrg!]!
	storages: [StorageOrg!]!
}

type Protocol implements Location @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocol {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocol {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocol {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocol {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryProtocol {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	name: String!
	form: ProtocolForm!
	plan: Plan!
	ages: [Int]
	ageStart: Int
	ageEnd: Int
	dobs: [DateTime]
	dobStart: DateTime
	dobEnd: DateTime
	race: [Race]
	sex: [Sex]
	specimens: [Specimen!]! @hasInverse(field: protocol)
}

interface Location {
	street: String! @search
	city: String! @search
	county: String! @search
	state: String! @search
	country: String! @search
	zip: Int! @search
}

type Result @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryResult {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryResult {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryResult {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryResult {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: ID!) {
			queryResult {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	lab: LabOrg!
	notes: String!
	specimen: Specimen!
	test: Test!
}

interface Specimen {
	id: ID!
	externalID: String!
	type: SpecimenType! @search
	collectionDate: DateTime! @search
	donor: Donor! @hasInverse(field: specimens)
	container: ContainerType! @search
	status: SpecimenStatus! @search
	destructionDate: DateTime! @search
	description: String!
	consent: Consent!
	owner: OwnerOrg!
	lab: LabOrg!
	storage: StorageOrg!
	protocol: Protocol!
	tests: [Test!]! @hasInverse(field: specimens)
	results: [Result!]! @hasInverse(field: specimen)
}

enum SpecimenType {
	BLOOD
}

enum ContainerType {
	VIAL
}

enum SpecimenStatus {
	DESTROYED
	EXHAUSTED
	IN_INVENTORY
	IN_TRANSIT
	LOST
	RESERVED
	TRANSFERRED
}

type BloodSpecimen {
	bloodType: BloodType! @search
	volume: Float!
}

enum BloodType {
	O_NEG
	O_POS
	A_NEG
	A_POS
	B_NEG
	B_POS
	AB_NEG
	AB_POS
}

type Test @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryTest {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryTest {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryTest {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: ID!) {
			queryTest {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: ID!) {
			queryTest {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	lab: LabOrg!
	specimens: [Specimen!]!
	results: [Result!]! @hasInverse(field: test)
}

type User @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: ID!) {
			queryUser {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: ID!) {
			queryUser {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: ID!) {
			queryUser {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: ID!) {
			queryUser {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: ID!) {
			queryUser {
				owner( filter: { id: [$orgID] } ) {
					id
				}
			}
		}"""},
	]},
) {
	owner: OwnerOrg!
	email: String! @id
	firstName: String! @search(by: [exact])
	lastName: String! @search(by: [exact])
	role: Role!
	org: Org! @hasInverse(field: users)
}

enum Role {
	USER_ADMIN
	USER_INTERNAL
	USER_LAB
}

# Dgraph.Authorization X-Auth0-Token https://tbd.io/jwt/claims RS256 "ALGORITHM_PUBLIC_KEY"
