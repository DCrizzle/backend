type Consent @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryConsent {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryConsent {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryConsent {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryConsent {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryConsent {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	date: DateTime! @search
	donor: Donor!
	form: ConsentForm!
}

type Donor @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{$role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryDonor {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{$role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryDonor {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{$role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryDonor {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
			{ rule: "{$role: { eq: \"USER_LAB\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryDonor {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryDonor {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	age: Int! @search
	dob: DateTime!
	sex: Sex!
	race: Race!
	street: String! @search
	city: String! @search
	county: String! @search
	state: String! @search
	country: String! @search
	zip: Int! @search
	specimens: [Specimen!]!
	consents: [Consent!]! @hasInverse(field: donor)
}

enum Sex {
	MALE
	FEMALE
}

enum Race {
	AMERICAN_INDIAN_OR_ALASKA_NATIVE
	ASIAN
	BLACK_OR_AFRICAN_AMERICAN
	HISPANIC_OR_LATINO
	WHITE
}

interface Form {
	id: ID!
	owner: OwnerOrg!
	title: String! @search(by: [fulltext])
	body: String! @search(by: [fulltext])
}

type ConsentForm implements Form {
	consent: Consent! @hasInverse(field: form)
}

type ProtocolForm implements Form {
	protocolID: String! @search
}

interface Org {
	id: ID!
	name: String!
	users: [User!]!
	createdOn: DateTime!
	updatedOn: DateTime!
	street: String! @search
	city: String! @search
	county: String! @search
	state: String! @search
	country: String! @search
	zip: Int! @search
}

type LabOrg implements Org {
	owner: OwnerOrg!
	specimens: [Specimen!]! @hasInverse(field: lab)
}

type OwnerOrg implements Org {
	labs: [LabOrg!]! @hasInverse(field: owner)
	storages: [StorageOrg!]! @hasInverse(field: owner)
}

type StorageOrg implements Org {
	owner: OwnerOrg!
	specimens: [Specimen!]! @hasInverse(field: storage)
}

type Plan @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryPlan {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryPlan {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryPlan {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryPlan {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryPlan {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	name: String!
	labs: [LabOrg!]!
	storages: [StorageOrg!]!
}

type Protocol @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryProtocol {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryProtocol {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryProtocol {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryProtocol {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryProtocol {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	name: String!
	form: ProtocolForm!
	plan: Plan!
	ages: [Int]
	ageStart: Int
	ageEnd: Int
	dobs: [DateTime]
	dobStart: DateTime
	dobEnd: DateTime
	race: [Race]
	sex: [Sex]
	specimens: [Specimen!]! @hasInverse(field: protocol)
	street: String! @search
	city: String! @search
	county: String! @search
	state: String! @search
	country: String! @search
	zip: Int! @search
}

type Result @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryResult {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryResult {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryResult {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryResult {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: String!) {
			queryResult {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	lab: LabOrg!
	notes: String!
	specimen: Specimen!
	test: Test!
}

interface Specimen {
	id: ID!
	owner: OwnerOrg!
	lab: LabOrg!
	storage: StorageOrg!
	protocol: Protocol!
	tests: [Test!]! @hasInverse(field: specimens)
	results: [Result!]! @hasInverse(field: specimen)
}

type BloodSpecimen {
	bloodType: BloodType! @search
}

enum BloodType {
	O_NEG
	O_POS
	A_NEG
	A_POS
	B_NEG
	B_POS
	AB_NEG
	AB_POS
}

type Test @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryTest {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryTest {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryTest {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ or: [
			{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
			{ rule: "{$role: { eq: \"USER_INTERNAL\" } }"},
		]},
		{ rule: """query($orgID: String!) {
			queryTest {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: String!) {
			queryTest {
				owner( filter: { id: { eq: $orgID } } ) {
					id
				}
			}
		}"""},
	]},
) {
	id: ID!
	owner: OwnerOrg!
	lab: LabOrg!
	specimens: [Specimen!]!
	results: [Result!]! @hasInverse(field: test)
}

type User @auth(
	add: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: String!) {
			queryUser {
				owner( filter: { id: { eq: $orgID } } ) {
					email
				}
			}
		}"""},
	]},
	query: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: String!) {
			queryUser {
				owner( filter: { id: { eq: $orgID } } ) {
					email
				}
			}
		}"""},
	]},
	get: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: String!) {
			queryUser {
				owner( filter: { id: { eq: $orgID } } ) {
					email
				}
			}
		}"""},
	]},
	update: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: String!) {
			queryUser {
				owner( filter: { id: { eq: $orgID } } ) {
					email
				}
			}
		}"""},
	]},
	delete: { and: [
		{ rule: "{ $isAuthenticated: { eq: \"true\" } }" },
		{ rule: "{$role: { eq: \"USER_ADMIN\" } }"},
		{ rule: """query($orgID: String!) {
			queryUser {
				owner( filter: { id: { eq: $orgID } } ) {
					email
				}
			}
		}"""},
	]},
) {
	owner: OwnerOrg!
	email: String! @id
	firstName: String! @search(by: [exact])
	lastName: String! @search(by: [exact])
	role: Role!
	org: Org! @hasInverse(field: users)
}

enum Role {
	USER_ADMIN
	USER_INTERNAL
	USER_LAB
}

# Dgraph.Authorization X-Auth0-Token https://tbd.io/jwt/claims RS256 "ALGORITHM_PUBLIC_KEY"
